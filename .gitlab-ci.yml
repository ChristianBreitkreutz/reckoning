image: registry.gitlab.com/reckoning/app:2.5.1

cache:
  key: gems
  paths:
    - vendor/bundle

variables:
  RAILS_ENV: test
  POSTGRES_DB: reckoning_test
  POSTGRES_USER: reckoning
  POSTGRES_PASSWORD: ""

stages:
  - checks
  - tests
  # - deploy

.default_template: &default_template
  before_script:
    - "bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=$(nproc) --retry=3"

audit:
  <<: *default_template
  script:
    - "bundle exec bundle-audit update"
    - "bundle exec bundle-audit check"
  stage: checks

rubocop:
  <<: *default_template
  script:
    - "bundle exec rubocop --format progress"
  stage: checks

.test_template: &test_template
  before_script:
    - "bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=$(nproc) --retry=3"
    - "bundle exec thor setup:dev_env"
    - "bundle exec rails db:schema:load"
  services:
    - postgres:latest
  stage: test

unit_tests:
  <<: *test_template
  script:
    - "bundle exec rails test"
  stage: tests
